<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head('account.title')}"></head>
<body>
<div th:insert="~{menunavy::navy}"></div>

<div class="container mt-4" style="max-width: 980px;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-0" th:text="#{account.title}">Account</h1>
            <div class="text-muted" th:text="#{account.subtitle}">
                Manage your profile, payment and security settings
            </div>
        </div>
        <a class="btn btn-outline-secondary" th:href="@{/}" th:text="#{home}">Home</a>
    </div>

    <div th:if="${success}" class="alert alert-success mt-3" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger mt-3" th:text="${error}"></div>

    <div class="card mt-3 shadow-sm">
        <div class="card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="fw-bold fs-5" th:text="${profile != null ? profile.name : '—'}">Name</div>
                    <div class="text-muted">
                        <span th:text="${email}">email</span>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="text-muted" th:text="#{client.balance}">Balance</div>
                    <div class="fs-4 fw-bold" th:text="${#numbers.formatDecimal(balance,1,2)}">0.00</div>
                </div>

                <div class="col-md-3">
                    <div class="text-muted" th:text="#{account.card}">Card</div>
                    <div class="fs-5 fw-bold">
                        <span th:if="${cardLast4 != null}" th:text="'**** ' + ${cardLast4}">**** 1234</span>
                        <span th:unless="${cardLast4 != null}" th:text="#{account.card.notSet}">Not set</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-profile" type="button" role="tab"
                    th:text="#{account.tab.profile}">
                Profile
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-payment" type="button" role="tab"
                    th:text="#{account.tab.payment}">
                Payment
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-security" type="button" role="tab"
                    th:text="#{account.tab.security}">
                Security
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link text-danger" data-bs-toggle="tab" data-bs-target="#tab-danger" type="button"
                    role="tab" th:text="#{account.tab.danger}">
                Danger
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 rounded-bottom p-3 bg-white">

        <!-- PROFILE TAB -->
        <div class="tab-pane fade show active" id="tab-profile" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-7">
                    <form th:action="@{/account/client/profile}" method="post"
                          th:object="${profile}" class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3" th:text="#{account.profile.title}">Public profile</h5>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{object.user.name}">Name</label>
                                <input class="form-control"
                                       th:field="*{name}"
                                       th:classappend="${#fields.hasErrors('name')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback"
                                     th:if="${#fields.hasErrors('name')}"
                                     th:errors="*{name}"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{object.user.email}">Email</label>
                                <input class="form-control" th:value="${email}" disabled>
                                <div class="form-text" th:text="#{account.email.cannotChange}">
                                    Email cannot be changed.
                                </div>
                            </div>

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-primary" type="submit" th:text="#{account.profile.save}">
                                Save profile
                            </button>
                        </div>
                    </form>
                </div>

                <div class="col-lg-5">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-2" th:text="#{account.tips.title}">Tips</h5>
                            <div class="text-muted" th:text="#{account.tips.text}">
                                Keep your name real — it will be used for delivery recipient by default (optional).
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAYMENT TAB -->
        <div class="tab-pane fade" id="tab-payment" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-6">
                    <form th:action="@{/account/client/card}" method="post" th:object="${card}" class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3" th:text="#{account.paymentCard.title}">Payment card</h5>

                            <div class="mb-2 text-muted">
                                <span th:text="#{account.current}">Current:</span>
                                <b>
                                    <span th:if="${cardLast4 != null}" th:text="'**** ' + ${cardLast4}">**** 1234</span>
                                    <span th:unless="${cardLast4 != null}"
                                          th:text="#{account.card.notSet}">Not set</span>
                                </b>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{account.cardNumber}">Card number</label>
                                <input class="form-control"
                                       th:placeholder="#{account.cardNumber.placeholder}"
                                       th:field="*{cardNumber}"
                                       th:classappend="${#fields.hasErrors('cardNumber')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback"
                                     th:if="${#fields.hasErrors('cardNumber')}"
                                     th:errors="*{cardNumber}"></div>
                                <div class="form-text" th:text="#{account.card.storeNote}">
                                    We store only last 4 digits and hash.
                                </div>
                            </div>

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-primary" type="submit" th:text="#{account.card.save}">
                                Save card
                            </button>
                        </div>
                    </form>
                </div>

                <div class="col-lg-6">
                    <form th:action="@{/account/client/balance}" method="post" th:object="${topup}"
                          class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3" th:text="#{client.balance}">Balance</h5>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{account.topup.amount}">Top up amount</label>
                                <input class="form-control"
                                       type="number"
                                       step="0.01"
                                       min="0.01"
                                       th:field="*{amount}"
                                       th:classappend="${#fields.hasErrors('amount')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback"
                                     th:if="${#fields.hasErrors('amount')}"
                                     th:errors="*{amount}"></div>
                            </div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-success" type="submit" th:text="#{account.topup.btn}">
                                    Top up
                                </button>

                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="document.getElementById('topupAmount').value=10">+10
                                </button>
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="document.getElementById('topupAmount').value=50">+50
                                </button>
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="document.getElementById('topupAmount').value=100">+100
                                </button>
                            </div>

                            <script>
                                document.addEventListener('DOMContentLoaded', () => {
                                    const el = document.querySelector('input[name="amount"]');
                                    if (el) el.id = 'topupAmount';
                                });
                            </script>

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-security" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-7">
                    <form th:action="@{/account/client/password}" method="post" th:object="${pwd}"
                          class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3" th:text="#{account.password.title}">Change password</h5>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{account.password.current}">Current password</label>
                                <input type="password" class="form-control"
                                       th:field="*{currentPassword}"
                                       th:classappend="${#fields.hasErrors('currentPassword')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback"
                                     th:if="${#fields.hasErrors('currentPassword')}"
                                     th:errors="*{currentPassword}"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{account.password.new}">New password</label>
                                <input type="password" class="form-control"
                                       th:field="*{newPassword}"
                                       th:classappend="${#fields.hasErrors('newPassword')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback"
                                     th:if="${#fields.hasErrors('newPassword')}"
                                     th:errors="*{newPassword}"></div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label" th:text="#{account.password.confirm}">Confirm new
                                    password</label>
                                <input type="password" class="form-control"
                                       th:field="*{confirmNewPassword}"
                                       th:classappend="${#fields.hasErrors('confirmNewPassword')} ? 'is-invalid' : ''">
                                <div class="invalid-feedback"
                                     th:if="${#fields.hasErrors('confirmNewPassword')}"
                                     th:errors="*{confirmNewPassword}"></div>
                            </div>

                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn btn-primary" type="submit" th:text="#{account.password.btn}">
                                Change password
                            </button>
                        </div>
                    </form>
                </div>

                <div class="col-lg-5">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-2" th:text="#{account.securityNote.title}">Security note</h5>
                            <div class="text-muted" th:text="#{account.securityNote.text}">
                                After changing password, you can keep current session or re-login — your choice.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-danger" role="tabpanel">
            <div class="card border-danger shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-danger" th:text="#{account.delete.title}">Delete account</h5>
                    <p class="text-muted mb-3" th:utext="#{account.delete.text}">
                        This will disable your profile. You can’t delete it if you have <b>NEW</b> orders.
                    </p>

                    <form th:action="@{/account/client/delete}" method="post"
                          th:attr="onsubmit=|return confirm('${#messages.msg('account.delete.confirm')}');|">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button class="btn btn-outline-danger" type="submit" th:text="#{account.delete.btn}">
                            Delete account
                        </button>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<div th:insert="~{footer::footer}"></div>
</body>
</html>
