<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/head :: head('catalog.title')}"></head>
<body>
<div th:insert="~{menunavy::navy}"></div>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center">
        <h1 class="mb-0" th:text="#{menu.catalog}">Catalog</h1>
        <a class="btn btn-outline-secondary" th:href="@{/(lang=${#locale.language})}" th:text="#{home}">Home</a>
    </div>

    <form class="card mt-3" method="get" th:action="@{/catalog}">
        <div class="card-body">
            <div class="row g-3 align-items-end">

                <div class="col-md-4">
                    <label class="form-label" th:text="#{catalog.search}">Search</label>
                    <input class="form-control"
                           name="q"
                           th:value="${filter.q}"
                           th:placeholder="#{catalog.search.placeholder}">
                </div>

                <div class="col-md-2">
                    <label class="form-label" th:text="#{catalog.category}">Category</label>
                    <select class="form-select" name="category">
                        <option value="" th:text="#{all}">All</option>
                        <option th:each="c : ${categories}"
                                th:value="${c.name()}"
                                th:selected="${filter.category != null and filter.category.name() == c.name()}"
                                th:text="${c.name()}">
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label" th:text="#{catalog.manufacturer}">Manufacturer</label>
                    <select class="form-select" name="manufacturerId">
                        <option value="" th:text="#{all}">All</option>
                        <option th:each="m : ${manufacturers}"
                                th:value="${m.id}"
                                th:selected="${filter.manufacturerId != null and filter.manufacturerId == m.id}"
                                th:text="${m.name}">
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label" th:text="#{catalog.powerType}">Power type</label>
                    <select class="form-select" name="powerType">
                        <option value="" th:text="#{all}">All</option>
                        <option th:each="p : ${powerTypes}"
                                th:value="${p.name()}"
                                th:selected="${filter.powerType != null and filter.powerType.name() == p.name()}"
                                th:text="${p.name()}">
                        </option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label" th:text="#{catalog.minPrice}">Min price</label>
                    <input class="form-control" type="number" step="0.01" min="0"
                           name="minPrice" th:value="${filter.minPrice}">
                </div>

                <div class="col-md-2">
                    <label class="form-label" th:text="#{catalog.maxPrice}">Max price</label>
                    <input class="form-control" type="number" step="0.01" min="0"
                           name="maxPrice" th:value="${filter.maxPrice}">
                </div>

                <div class="col-md-3">
                    <label class="form-label" th:text="#{catalog.sort}">Sort</label>
                    <select class="form-select" name="sort">
                        <option value="" th:text="#{catalog.sort.default}">Default</option>
                        <option value="id,desc"   th:selected="${param.sort != null and param.sort[0] == 'id,desc'}"   th:text="#{catalog.sort.newest}">Newest</option>
                        <option value="id,asc"    th:selected="${param.sort != null and param.sort[0] == 'id,asc'}"    th:text="#{catalog.sort.oldest}">Oldest</option>
                        <option value="price,asc" th:selected="${param.sort != null and param.sort[0] == 'price,asc'}" th:text="#{catalog.sort.priceAsc}">Price: low → high</option>
                        <option value="price,desc"th:selected="${param.sort != null and param.sort[0] == 'price,desc'}"th:text="#{catalog.sort.priceDesc}">Price: high → low</option>
                        <option value="name,asc"  th:selected="${param.sort != null and param.sort[0] == 'name,asc'}"  th:text="#{catalog.sort.nameAsc}">Name: A → Z</option>
                        <option value="name,desc" th:selected="${param.sort != null and param.sort[0] == 'name,desc'}" th:text="#{catalog.sort.nameDesc}">Name: Z → A</option>
                        <option value="power,asc" th:selected="${param.sort != null and param.sort[0] == 'power,asc'}" th:text="#{catalog.sort.powerAsc}">Power: low → high</option>
                        <option value="power,desc"th:selected="${param.sort != null and param.sort[0] == 'power,desc'}"th:text="#{catalog.sort.powerDesc}">Power: high → low</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label" th:text="#{catalog.perPage}">Per page</label>
                    <select class="form-select" name="size">
                        <option value="6"  th:selected="${page.size == 6}">6</option>
                        <option value="9"  th:selected="${page.size == 9}">9</option>
                        <option value="12" th:selected="${page.size == 12}">12</option>
                        <option value="24" th:selected="${page.size == 24}">24</option>
                    </select>
                </div>

                <input type="hidden" name="page" value="0"/>

                <div class="col-md-3 d-flex gap-2">
                    <button class="btn btn-primary" type="submit" th:text="#{apply}">Apply</button>
                    <a class="btn btn-outline-secondary" th:href="@{/catalog}" th:text="#{reset}">Reset</a>
                </div>

            </div>
        </div>
    </form>

    <div class="mt-3 text-muted small"
         th:text="'totalElements=' + ${page.totalElements} + ', itemsOnPage=' + ${appliances.size()}">
        totalElements=0, itemsOnPage=0
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-3 mt-2">

        <div class="col" th:each="a : ${appliances}">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title mb-1" th:text="${a.name}">Name</h5>

                    <div class="text-muted small mb-2">
                        <span th:text="${a.manufacturerName}">Manufacturer</span>
                        <span th:if="${a.category != null}"> • <span th:text="${a.category}">Category</span></span>
                    </div>

                    <div class="mt-auto">
                        <div class="fs-5 fw-bold" th:text="${a.price}">0</div>

                        <div class="d-flex gap-2 mt-2 flex-wrap">
                            <a class="btn btn-outline-primary"
                               th:href="@{/catalog/{id}(id=${a.id})}"
                               th:text="#{details}">
                                Details
                            </a>

                            <form sec:authorize="hasRole('CLIENT')"
                                  th:action="@{/catalog/{id}/add-to-cart(id=${a.id})}"
                                  method="post" class="d-inline">
                                <input type="hidden" name="quantity" value="1"/>
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn btn-primary" type="submit" th:text="#{catalog.addToCart}">
                                    Add to cart
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="col-12" th:if="${#lists.isEmpty(appliances)}">
            <div class="alert alert-info mt-3" th:text="#{catalog.noItems}">
                No items found.
            </div>
        </div>

    </div>

    <nav th:if="${page.totalPages > 1}" class="mt-4">
        <ul class="pagination">

            <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/catalog(page=${page.number-1}, size=${page.size}, sort=${param.sort},
                   q=${filter.q}, category=${filter.category}, manufacturerId=${filter.manufacturerId},
                   powerType=${filter.powerType}, minPrice=${filter.minPrice}, maxPrice=${filter.maxPrice})}"
                   th:text="#{prev}">
                    Prev
                </a>
            </li>

            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, page.totalPages-1)}"
                th:classappend="${i == page.number} ? 'active'">
                <a class="page-link"
                   th:text="${i+1}"
                   th:href="@{/catalog(page=${i}, size=${page.size}, sort=${param.sort},
                   q=${filter.q}, category=${filter.category}, manufacturerId=${filter.manufacturerId},
                   powerType=${filter.powerType}, minPrice=${filter.minPrice}, maxPrice=${filter.maxPrice})}">
                </a>
            </li>

            <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{/catalog(page=${page.number+1}, size=${page.size}, sort=${param.sort},
                   q=${filter.q}, category=${filter.category}, manufacturerId=${filter.manufacturerId},
                   powerType=${filter.powerType}, minPrice=${filter.minPrice}, maxPrice=${filter.maxPrice})}"
                   th:text="#{next}">
                    Next
                </a>
            </li>

        </ul>
    </nav>

</div>

<div th:insert="~{footer::footer}"></div>
</body>
</html>
